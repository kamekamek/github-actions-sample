# Claude Code `/agents` 機能 完全ガイド

## 概要

Claude Code の `/agents` 機能は、**特定のタスクに特化したカスタムAIサブエージェントを管理するインタラクティブスラッシュコマンド**です。この機能により、開発者は複雑なワークフローを効率的に自動化し、並列処理によってタスクを高速化できる強力な開発プラットフォームを構築できます。

## 基本機能と構文

### `/agents` コマンド構文
```bash
/agents
```

### 主要機能
1. **インタラクティブ管理インターフェース**の提供
2. **利用可能なツール一覧**の表示（MCPサーバーツールを含む）
3. **新しいサブエージェントの作成**
4. **既存エージェント設定の変更**
5. **ツール選択と権限管理**

### スラッシュコマンドシステム統合
- **アクセス方法**: `/` を入力することでスラッシュコマンドメニューが表示
- **ヘルプ機能**: `/help` コマンドですべての利用可能なコマンドとその機能を確認可能
- **カスタムコマンド**: `.claude/commands` フォルダにMarkdownファイルを配置してカスタムコマンドを作成

## サブエージェントアーキテクチャ

### ファイル配置場所（優先順位順）

```
1. プロジェクトレベル（最高優先度）
   .claude/agents/

2. ユーザーレベル（低優先度）  
   ~/.claude/agents/
```

### サブエージェント定義ファイル構造

```markdown
---
name: エージェント名
description: "このエージェントをいつ呼び出すか、何をするかの説明"
tools: tool1, tool2, tool3  # オプション - 省略時は全ツールを継承
color: green               # オプション - 視覚的識別子
priority: high             # オプション - 実行優先度
environment: production    # オプション - 環境設定
context_mode: minimal      # オプション - 初期化時間の短縮
---

# システムプロンプトコンテンツ
エージェントの動作と専門知識に関する詳細な指示。
```

### 並列処理能力
- **並列度制限**: 最大10個のサブエージェントまで同時実行可能
- **バッチ処理**: 制限を超える場合はキューイングされ、バッチ単位で実行
- **コンテキストウィンドウ**: 各サブエージェントが独自のコンテキストウィンドウを保持

### サブエージェントの専門分野
1. **ファイル操作**: 読み書き、検索、分析
2. **コード処理**: 検索、解析、リファクタリング
3. **Bash操作**: システムコマンド実行
4. **リサーチタスク**: 情報収集、調査
5. **テスト実行**: 自動テスト、検証

## 実践的な使用例

### 例1: セキュリティ特化コードレビューエージェント

```markdown
---
name: security-reviewer
description: "セキュリティ脆弱性に特化したコードレビュー。OWASP準拠とセキュアコーディングプラクティスに焦点を当てる"
tools: Read, Grep, Glob, Bash
color: red
priority: high
---

あなたはセキュリティ専門のコードレビュアーです。以下の観点でコードを分析してください：

## 分析項目
1. **認証・認可の問題**
   - 不適切な認証メカニズム
   - 権限昇格の脆弱性
   - セッション管理の問題

2. **入力検証**
   - SQLインジェクション
   - XSS（クロスサイトスクリプティング）
   - コマンドインジェクション

3. **データ保護**
   - 機密情報の平文保存
   - 不適切な暗号化実装
   - ログでの機密情報漏洩

4. **OWASP Top 10 準拠性**
   - 最新のOWASP脆弱性リストとの照合
   - セキュリティ設定の不備

## レビュー手順
1. コード全体の構造分析
2. 各脆弱性カテゴリーでの詳細検査
3. 修正提案とベストプラクティスの提示
4. セキュリティテストの推奨
```

### 例2: パフォーマンス最適化エージェント

```markdown
---
name: performance-optimizer
description: "コードパフォーマンスの分析と最適化。ボトルネックの特定と改善提案を行う"
tools: Read, Grep, Glob, Bash
color: blue
---

パフォーマンス最適化の専門家として、以下の手順でコードを分析します：

## 分析手順
1. **プロファイリング**
   - CPU使用率の分析
   - メモリ消費パターンの確認
   - I/O操作の効率性評価

2. **ボトルネック特定**
   - 実行時間の長い処理の特定
   - 非効率なアルゴリズムの検出
   - データベースクエリの最適化機会

3. **最適化提案**
   - アルゴリズムの改善案
   - データ構造の最適化
   - キャッシュ戦略の提案
   - 並列処理の機会

4. **ベンチマーク**
   - 最適化前後の性能比較
   - 測定方法の提案
```

### 例3: テスト自動実行エージェント

```markdown
---
name: test-runner
description: "コード変更時に自動的にテストを実行し、失敗時は分析・修正を行う"
tools: Read, Write, Bash, Grep
color: green
priority: high
---

テスト自動化の専門家として、以下のワークフローを実行します：

## 自動実行タスク
1. **テスト検出**
   - 変更されたファイルに関連するテストの特定
   - テストスイート全体の必要性判断

2. **テスト実行**
   - 単体テストの実行
   - 統合テストの実行
   - カバレッジレポートの生成

3. **失敗分析**
   - エラーメッセージの詳細分析
   - 失敗原因の特定
   - 修正方針の提案

4. **修正実装**
   - テストの意図を保持した修正
   - リグレッション防止の確認
   - 修正後の再実行
```

## 高度な機能

### MCP（Model Context Protocol）統合

#### 2025年の進化
- **業界標準化**: OpenAI（3月）、Google DeepMind（4月）が正式採用
- **エコシステム拡大**: 5,000以上のコミュニティMCPサーバーが利用可能
- **企業統合**: Azure AI Agent Serviceとの統合実現

#### 主要MCPサーバー
- **GitHub**: イシュー管理、PR処理、CI/CD連携
- **Apidog**: API文書化、テスト、コード生成
- **統合サービス**: Google Drive、Slack、Postgres、Puppeteer

### マルチエージェントワークフロー

#### 並列実装パターン
```
7-並列Taskメソッド:
1. Component: メインコンポーネントファイル作成
2. Styles: コンポーネントスタイル/CSS作成
3. Tests: テストファイル作成
4. Types: 型定義作成
5. Hooks: カスタムフック/ユーティリティ作成
6. Integration: ルーティング、インポート、エクスポート更新
7. Remaining: package.json、文書化、設定ファイル更新
```

#### エージェントクラスター管理
- **Claude Squad**: 複数のClaude Code、Codex、Geminiエージェントを並行管理
- **管理可能数**: 熟練者は最大10個のエージェントを同時管理可能
- **ワークスペース分離**: 各エージェントが独立したワークスペースで動作

## 高度な設定オプション

### settings.local.json での権限管理

```json
{
  "permissions": {
    "allow": [
      "Bash(npm test, npm run lint)",
      "WebFetch(domain:*.github.com)",
      "Read",
      "Write",
      "Grep"
    ],
    "deny": [
      "Bash(rm -rf)",
      "WebFetch(domain:untrusted.com)"
    ]
  },
  "agents": {
    "auto_delegate": true,
    "parallel_limit": 5,
    "context_preservation": "minimal"
  }
}
```

### 引数付きエージェント

```markdown
---
name: github-issue-fixer
description: "GitHub イシューを分析して修正。使用例: /agents github-issue-fixer 1234"
tools: Read, Write, Bash, WebFetch
---

GitHub イシュー #$ARGUMENTS を分析し、以下の手順で修正を行います：

1. イシューの詳細取得と分析
2. 関連コードの特定
3. 修正方針の策定
4. 実装とテスト
5. PR作成の準備
```

## 使用パターンと戦略

### 1. 自動委任パターン
```javascript
// コード変更後、Claude Code が自動的に適切なエージェントを選択
// 例: セキュリティ関連の変更 → security-reviewer が自動起動
```

### 2. 明示的呼び出しパターン
```bash
# 特定のエージェントを明示的に呼び出し
> security-reviewer を使って最新の変更をチェックして
> performance-optimizer でこの関数を最適化して
> test-runner でテストを実行して失敗を修正して
```

### 3. 並列マルチエージェントパターン
```bash
# 複数のエージェントを並列実行
> security-reviewer と performance-optimizer を並列で実行して、
> 結果を統合して包括的な分析レポートを作成して
```

### 4. カスタムコマンド統合パターン

`.claude/commands/comprehensive-review.md`:
```markdown
以下のエージェントを順次実行して包括的なコードレビューを実施：

1. security-reviewer でセキュリティ分析
2. performance-optimizer でパフォーマンス分析  
3. test-runner でテスト実行と検証
4. 結果の統合と改善提案の作成
```

## カスタムコマンドとの統合

### 設定方法
```markdown
# .claude/commands/fix-github-issue.md に配置
/project:fix-github-issue 1234 として利用可能

# ~/.claude/commands/ に配置
全セッションで利用可能なパーソナルコマンド
```

### 一般的なコマンド例
- **モデル切り替え**: Opus（深い思考）、Sonnet（高速処理）
- **/ide**: IDE連携、リンターエラー修正
- **/install-github-app**: 自動PRレビュー機能

### CLAUDE.mdフレームワーク
- **目的**: プロジェクトの包括的文書化
- **効果**: ビジネス要件と技術仕様の連携により、1-2回の試行で動作コードを生成
- **メリット**: 数十回の反復作業を削減

## エージェント管理のベストプラクティス

### 1. エージェント設計原則
- **単一責任**: 1つのエージェントは1つの専門分野に集中
- **明確な境界**: 役割と責任の明確な定義
- **再利用性**: プロジェクト間で再利用可能な設計

### 2. 命名規則
```
形式: 目的-機能
例:
- security-reviewer（セキュリティレビュー）
- performance-optimizer（パフォーマンス最適化）
- test-automation（テスト自動化）
- docs-generator（文書生成）
```

### 3. ツール制限戦略
```yaml
# セキュリティ重視の制限例
tools: Read, Grep, Glob  # 読み取り専用操作のみ

# 実装エージェントの場合
tools: Read, Write, Bash, Grep, Glob  # 実装に必要な全ツール

# 研究特化エージェントの場合  
tools: WebFetch, Read, Grep  # 情報収集に特化
```

### 4. コンテキスト最適化
```yaml
context_mode: minimal  # 初期化高速化
context_mode: full     # 完全なコンテキスト保持
context_mode: selective # 選択的コンテキスト保持
```

### 5. タスク編成の原則
1. **明示的な委任**: マルチスレッドプログラミングのような明確な指示が必要
2. **関連タスクのグループ化**: 個別エージェント作成よりも効率的
3. **トークンコスト最適化**: パフォーマンス向上とコスト削減のバランス
4. **段階的処理**: 計画→実行→検証→統合のフェーズ分離

## パフォーマンス向上戦略

- **並列実行**: 独立したタスクの同時処理
- **コンテキスト管理**: 各エージェントの独立したコンテキストウィンドウ活用
- **効率的な委任**: 読み取り/取得操作中心の慎重なサブエージェント使用

## Task ツールとの比較

### Task ツールによるサブエージェント生成
```
Task ツールの仕組み:
- メインエージェントと同じツールアクセス権限を持つサブエージェントを生成
- ネストしたサブタスクの生成は不可（制限事項）
- 結果をメインエージェントに報告
```

### 主要な違い

#### `/agents` (サブエージェント):
- **永続的設定**: ファイルで定義、セッション間で再利用可能
- **専門システムプロンプト**: カスタム動作と専門知識
- **ツール制限**: セキュリティのため特定ツールに制限可能
- **コンテキスト分離**: エージェントごとに独立したコンテキストウィンドウ
- **自動選択**: タスクコンテキストに基づくClaude Codeの自動委任

#### Task ツール:
- **一時的委任**: 一時的なサブタスクを作成
- **同一ツールアクセス**: メインエージェントからすべてのツールを継承（Task ツール自体を除く）
- **カスタムプロンプトなし**: デフォルトのClaude動作を使用
- **単一使用**: 結果をメイン会話に返す
- **手動呼び出し**: メインエージェントによる明示的呼び出しが必要

## 実装例：プロダクション向けエージェント

### フルスタック開発エージェント

```markdown
---
name: fullstack-developer
description: "フロントエンドからバックエンドまで包括的な開発支援"
tools: Read, Write, Bash, Grep, Glob, WebFetch
color: purple
---

フルスタック開発者として、以下の技術スタックに対応します：

## フロントエンド
- React/Vue/Angular
- TypeScript/JavaScript
- CSS/SCSS/Tailwind
- 状態管理（Redux, Vuex等）

## バックエンド  
- Node.js/Python/Java/Go
- RESTful API/GraphQL
- データベース設計・最適化
- 認証・認可システム

## DevOps・インフラ
- CI/CD パイプライン
- コンテナ化（Docker/Kubernetes）
- クラウドサービス（AWS/GCP/Azure）
- モニタリング・ログ管理

## 開発ワークフロー
1. 要件分析と技術選定
2. アーキテクチャ設計
3. 段階的実装
4. テスト・品質保証
5. デプロイ・運用サポート
```

## 技術制限と対策

### 現在の制限事項
1. **ネストしたエージェント生成不可**: サブエージェントはさらなるサブエージェントを生成できない
2. **バッチ実行**: 現在のバッチが完了するまで次のバッチは開始されない
3. **階層構造の制限**: 複雑な階層エージェント構造は制限される

### 回避策
- **Bashツール活用**: `claude -p` を通じた間接的なエージェント生成
- **効率的なタスク分割**: 適切な粒度でのタスク分解
- **ストラテジックな調整**: 制限内での最適なワークフロー設計

## トラブルシューティング

### よくある問題と解決策

1. **エージェントが認識されない**
   ```bash
   # ファイル配置確認
   ls -la .claude/agents/
   
   # YAML形式の確認
   cat .claude/agents/your-agent.md
   ```

2. **ツール権限エラー**
   ```json
   // settings.local.json で権限確認
   {
     "permissions": {
       "allow": ["必要なツール名"]
     }
   }
   ```

3. **パフォーマンス低下**
   ```yaml
   # context_mode を最適化
   context_mode: minimal
   
   # 不要なツールを除外
   tools: Read, Grep  # 必要最小限に限定
   ```

## 2025年のエコシステム動向

### 業界動向
- **標準化の進展**: MCPが「AIのためのUSB-C」として確立
- **コミュニティ成長**: 1,000以上のコミュニティサーバーが活用可能
- **エンタープライズ採用**: 主要AI企業による標準採用

### 将来性
- **汎用AIエージェント**: 単なるコーディングエージェントを超えた汎用的なインテリジェンス
- **自動化革命**: 複雑なインフラ要件を数分で実装可能な変革的能力
- **マルチモーダル統合**: 健康データ分析から構造化データ抽出まで多様な応用

## まとめ

Claude Code の `/agents` 機能は、2025年において開発ワークフローの根本的変革をもたらす技術として確立されています。単純なコード補完を超えて、複雑なマルチエージェントワークフロー、並列タスク処理、専門分野の専門知識を組み合わせた包括的な開発プラットフォームとして進化しています。

専門的なAIアシスタントを通じて開発ワークフローを大幅に効率化する強力なツールです。適切な設計と実装により、コードレビュー、テスト自動化、パフォーマンス最適化、セキュリティ分析など、あらゆる開発タスクを専門家レベルで自動化できます。

MCP統合、サブエージェント並列処理、カスタムコマンド作成により、開発者は前例のない効率性と自動化を実現できるようになっています。適切な理解と実装により、従来の開発プロセスを大幅に加速し、より高度で複雑なタスクへの対応が可能となります。

プロジェクトの要件に応じてカスタマイズされたエージェントを作成し、チーム全体での一貫した品質と効率性を実現することが可能になります。